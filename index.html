<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>健行科技大學114-1期初特定人員清查工作</title>
  <style>
    :root { --gap: 12px; --radius: 12px; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; padding: 24px; background:#f7f7fb; }
    .card { background:#fff; border-radius:var(--radius); padding:22px; box-shadow:0 6px 20px rgba(30,30,60,.06); max-width:980px; margin:auto; }
    h1 { margin:0 0 6px; font-size:22px; }
    .sub { color:#555; margin:0 0 14px; }
    .note { background:#f0f4ff; border:1px solid #e0e6ff; padding:12px; border-radius:10px; margin-bottom:14px; color:#2d3a7c; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .row-1 { grid-template-columns: 1fr; }
    label { display:block; font-size:14px; color:#333; margin-bottom:6px; }
    input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; background:#fff; }
    input:focus, select:focus { outline:none; border-color:#5b7cff; box-shadow:0 0 0 3px rgba(91,124,255,.15); }
    .section { border:1px dashed #e3e3ee; padding:16px; border-radius:10px; background:#fafafe; margin-top:14px; }
    .section h3 { margin:0 0 10px; font-size:16px; color:#333; }
    .toolbar { display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:18px; }
    button { padding:12px 16px; border:none; border-radius:10px; cursor:pointer; }
    .btn-outline { background:#fff; border:1px solid #ddd; }
    .btn-primary { background:#5b7cff; color:#fff; }
    .btn-danger { background:#e54848; color:#fff; }
    .status { margin-top:14px; font-size:14px; }
    .hidden { display:none !important; }
    .muted { color:#666; font-size:13px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#eef0f5; padding:2px 6px; border-radius:6px; font-size:12px; }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; z-index:50; }
    .modal { background:#fff; max-width:780px; width:calc(100% - 32px); border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden; }
    .modal header { padding:14px 16px; font-weight:700; border-bottom:1px solid #eee; }
    .modal .body { padding:14px 16px; line-height:1.7; max-height:65vh; overflow:auto; white-space:pre-wrap; }
    .modal footer { padding:12px 16px; display:flex; justify-content:flex-end; border-top:1px solid #eee; }

    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#eef0f5; font-size:12px; color:#333; }
    .ok-panel { text-align:center; padding:28px 12px; }
  </style>
</head>
<body>
  <div class="card" id="app">
    <h1>健行科技大學114-1期初特定人員清查工作</h1>
    <p class="sub">截止：<b>10月3日</b>；依教育部臺教學(五)字第<b>1142803363</b>號函辦理。</p>
    <div class="note">
      依規定，特定人員類別如下：
      <ol style="margin:6px 0 0 22px;">
        <li>A. 曾有違反毒危條例行為之各級學校學生（含自動請求治療者）。</li>
        <li>B. 各級學校休學、中輟或中途離校後申請復學之學生，有事實足認有施用毒品嫌疑者。</li>
        <li>C. 有事實足認為有施用毒品嫌疑之各級學校學生。（<a href="#" id="openGuideline">「特定人員事實認定觀察建議原則」</a>）</li>
        <li>D. 前三目以外之未成年學生，經學校認為有必要並取得法定代理人/實際照顧者同意者。</li>
      </ol>
    </div>

    <!-- Q1/Q1b/Q2 基本資料 -->
    <div class="section" id="sec-basic">
      <h3>基本資料</h3>
      <div class="row">
        <div>
          <label for="reporterName">1. 請問您的姓名（填報人）</label>
          <input id="reporterName" placeholder="請輸入您的姓名" required />
        </div>
        <div>
          <label for="reporterEmail">電子信箱</label>
          <input id="reporterEmail" type="email" placeholder="example@mail.com" required />
        </div>
        <div>
          <label for="className">2. 請問您任教的班級</label>
          <input id="className" placeholder="例：資工一甲" required />
        </div>
      </div>
    </div>

    <!-- Q3 是否有特定人員 -->
    <div class="section" id="sec-has">
      <h3>3. 貴班是否有學生需要列入特定人員？</h3>
      <div class="row-1">
        <label class="muted">（選擇「無」將清空下方區域並顯示完成訊息）</label>
        <div>
          <select id="hasSpecial">
            <option value="">— 請選擇 —</option>
            <option value="yes">有</option>
            <option value="no">無</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Q4 人數 -->
    <div class="section hidden" id="sec-count">
      <h3>4. 請問貴班需要列入特定人員的人數</h3>
      <div class="row">
        <div>
          <select id="declareCount">
            <option value="">— 請選擇（1–10）—</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
          </select>
        </div>
        <div class="pill" id="progressPill" aria-live="polite">已填 0 / 0</div>
      </div>
    </div>

    <!-- Q5 逐位填寫區（單頁，不跳轉） -->
    <div class="section hidden" id="sec-student">
      <h3>5. 請提供需要列入特定人員的學生資訊</h3>
      <div class="row">
        <div>
          <label id="lblStudentName">（第 1 位）姓名</label>
          <input id="stuName" placeholder="學生姓名" />
        </div>
        <div>
          <label>學號</label>
          <input id="stuId" placeholder="學號" />
        </div>
        <div>
          <label>性別</label>
          <select id="stuGender">
            <option value="">— 請選擇 —</option>
            <option value="男">男</option>
            <option value="女">女</option>
          </select>
        </div>
        <div>
          <label>特定人員類別</label>
          <select id="stuCategory">
            <option value="">— 請選擇 —</option>
            <option value="A">A. 曾有違反毒危條例行為（含自動請求治療者）</option>
            <option value="B">B. 休學/中輟/中途離校後申復學，疑似施用</option>
            <option value="C">C. 有事實足認疑似施用（參考附件一）</option>
            <option value="D">D. 未成年、經同意且學校認為必要者</option>
          </select>
        </div>
      </div>

      <div class="toolbar" id="navButtons">
        <button class="btn-outline" id="btnNext">填寫下一位資料</button>
        <button class="btn-primary" id="btnFinish">填報完成</button>
      </div>
      <div class="status" id="saveHint" aria-live="polite"></div>
    </div>

    <!-- 完成（無特定人員）訊息區 -->
    <div class="section hidden" id="sec-none">
      <div class="ok-panel">
        <p>感謝您的作答。如學期中有發現學生符合「特定人員事實認定觀察建議原則」，仍可隨時向承辦單位軍訓室提供增列需求。</p>
        <p>承辦人：軍訓室邱信國教官　分機：<b>3902</b></p>
        <div class="toolbar" style="justify-content:center">
          <button class="btn-outline" id="btnReset">重新填寫</button>
        </div>
      </div>
    </div>

    <!-- 送出狀態 -->
    <div id="status" class="status"></div>
  </div>

  <!-- 原則彈窗（附件一） -->
  <div class="modal-backdrop hidden" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <header>特定人員事實認定觀察建議原則</header>
      <div class="body" id="guidelineBody"></div>
      <footer>
        <button class="btn-primary" id="btnCloseModal">我知道了</button>
      </footer>
    </div>
  </div>

  <script>
    // === 0) 請把這個換成你部署後的 GAS Web App URL ===
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby26T0D6j9pw286ZZTlczbtYCvNCY2vCvfrO5qpS8430ZhuPMAt7MfaJ6WKEHctzGCI/exec";

    // === 1) 節點快取 ===
    const el = id => document.getElementById(id);
    const secCount = el('sec-count');
    const secStudent = el('sec-student');
    const secNone = el('sec-none');
    const statusEl = el('status');
    const saveHint = el('saveHint');
    const progressPill = el('progressPill');
    const navButtons = el('navButtons');

    // === 2) 彈窗資料 ===
    const guidelineText = `特定人員評估參考原則\n一、原則說明：\n（一）本原則係協助學校提列特定人員參考，勿僅以單一行為或事項做為提列之考量依據。\n（二）學校提列特定人員除參考本原則外，應依學生性格成長環境、經常往來對象、參與團體、出入場所、生活作息、家庭功能、就學或就業等情形進行綜合評估；並透過關懷及輔導等作為，協助學生改善相關行為或提供必要之協助。`;

    el('openGuideline').addEventListener('click', (e) => {
      e.preventDefault();
      el('guidelineBody').textContent = guidelineText;
      el('modalBackdrop').classList.remove('hidden');
    });
    el('btnCloseModal').addEventListener('click', () => el('modalBackdrop').classList.add('hidden'));

    // === 3) 狀態 ===
    let declareCount = 0; // 使用者於 Q4 宣告的人數
    let saved = [];       // 已完成暫存的學生 [{name,id,gender,category}]
    let index = 1;        // 正在填第幾位（1-based）

    function updateProgress() {
      progressPill.textContent = `已填 ${saved.length} / ${declareCount}`;
      el('lblStudentName').textContent = `（第 ${index} 位）姓名`;
      // 只有 1 人時，隱藏「下一位」按鈕
      if (declareCount <= 1) {
        el('btnNext').classList.add('hidden');
      } else {
        el('btnNext').classList.remove('hidden');
      }
    }

    function showSectionCountAndStudent(show) {
      secCount.classList.toggle('hidden', !show);
      secStudent.classList.toggle('hidden', !show);
      secNone.classList.add('hidden');
    }

    // === 4) Q3 有/無 ===
    el('hasSpecial').addEventListener('change', (e) => {
      const v = e.target.value;
      if (v === 'yes') {
        // 顯示 Q4/Q5
        declareCount = 0; saved = []; index = 1;
        el('declareCount').value = '';
        clearStudentForm();
        showSectionCountAndStudent(true);
        updateProgress();
      } else if (v === 'no') {
        // 清空下方並顯示完成訊息
        declareCount = 0; saved = []; index = 1; clearStudentForm();
        secCount.classList.add('hidden');
        secStudent.classList.add('hidden');
        secNone.classList.remove('hidden');
        statusEl.textContent = '';
      } else {
        // 未選
        showSectionCountAndStudent(false);
      }
    });

    // === 5) Q4 人數 ===
    el('declareCount').addEventListener('change', (e) => {
      declareCount = Number(e.target.value || 0);
      saved = []; index = 1; clearStudentForm();
      updateProgress();
      saveHint.textContent = '';
    });

    function getStudentFromForm() {
      return {
        name: el('stuName').value.trim(),
        id: el('stuId').value.trim(),
        gender: el('stuGender').value,
        category: el('stuCategory').value
      };
    }

    function clearStudentForm() {
      el('stuName').value = '';
      el('stuId').value = '';
      el('stuGender').value = '';
      el('stuCategory').value = '';
    }

    function validateBasic() {
      const reporterName = el('reporterName').value.trim();
      const reporterEmail = el('reporterEmail').value.trim();
      const className = el('className').value.trim();
      if (!reporterName) throw new Error('請填寫「您的姓名（填報人）」');
      if (!reporterEmail) throw new Error('請填寫「電子信箱」');
      if (!className) throw new Error('請填寫「任教班級」');
      return { reporterName, reporterEmail, className };
    }

    function validateStudent(stu) {
      if (!stu.name) throw new Error('請填寫學生「姓名」');
      if (!stu.id) throw new Error('請填寫學生「學號」');
      if (!stu.gender) throw new Error('請選擇學生「性別」');
      if (!stu.category) throw new Error('請選擇「特定人員類別」');
    }

    // === 6) 下一位 ===
    el('btnNext').addEventListener('click', () => {
      try {
        if (declareCount <= 1) return; // 不該出現，但保險
        validateBasic();
        const stu = getStudentFromForm();
        validateStudent(stu);
        saved.push(stu);
        index = saved.length + 1;
        clearStudentForm();
        updateProgress();
        saveHint.textContent = '✅ 已暫存此位資料，請繼續下一位。';
      } catch (err) {
        saveHint.textContent = '❌ ' + (err.message || err);
      }
    });

    // === 7) 完成送出 ===
    el('btnFinish').addEventListener('click', async () => {
      try {
        // 基本資料
        const base = validateBasic();
        if (el('hasSpecial').value !== 'yes') {
          statusEl.textContent = '❌ 請於第3題選擇「有」或改為「無」';
          return;
        }
        if (!declareCount) throw new Error('請於第4題選擇人數');

        // 若目前表單有填內容，嘗試收下
        const cur = getStudentFromForm();
        const hasAny = cur.name || cur.id || cur.gender || cur.category;
        if (hasAny) {
          try { validateStudent(cur); saved.push(cur); } catch(_) { /* 未完整就不收 */ }
        }

        if (saved.length < declareCount) {
          const ok = confirm(`您填答的特定人員人數少於 ${declareCount} 人（目前 ${saved.length} 人），確定結束嗎？`);
          if (!ok) return; // 繼續填寫
        }

        if (saved.length === 0) throw new Error('尚未填入任何學生資料');

        // 準備 payload
        const payload = {
          reporterName: base.reporterName,
          reporterEmail: base.reporterEmail,
          className: base.className,
          declareCount,
          students: saved
        };

        statusEl.textContent = '傳送中…';

        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let json; try { json = JSON.parse(text); } catch { json = { ok: res.ok, raw: text }; }
        if (!res.ok || json.ok === false) throw new Error(json.message || '寫入失敗，請稍後再試');

        statusEl.textContent = '✅ 已將您填報的資料輸入特定人員建議名冊。感謝您的協助！';
        // 可選：重置
        // document.getElementById('btnReset').click();
      } catch (err) {
        statusEl.textContent = '❌ ' + (err.message || err);
      }
    });

    // 重新填寫（顯示於無特定人員時）
    el('btnReset').addEventListener('click', () => {
      document.querySelector('#app').scrollIntoView({behavior: 'smooth'});
      // 清空所有狀態
      ['reporterName','reporterEmail','className'].forEach(id => el(id).value = '');
      el('hasSpecial').value = '';
      el('declareCount').value = '';
      clearStudentForm();
      declareCount = 0; saved = []; index = 1; updateProgress();
      secCount.classList.add('hidden');
      secStudent.classList.add('hidden');
      secNone.classList.add('hidden');
      statusEl.textContent = '';
    });

    // 初始
    updateProgress();
  </script>
</body>
</html>
